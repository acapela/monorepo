:3000

handle_path /graphql {
	rewrite * /v1/graphql
	reverse_proxy {$HASURA_HOST}
}

handle_path /api/backend/* {
	rewrite * /api{path}
	reverse_proxy {$BACKEND_HOST}
}

handle_path /api/auth/* {
	rewrite * /api/auth/{path}
	reverse_proxy {$BACKEND_HOST}
}

handle_path /api/backend/healthz {
	rewrite * /healthz
	reverse_proxy {$BACKEND_HOST}
}

handle_path /attachments/* {
	rewrite * /attachments{path}
	reverse_proxy {$BACKEND_HOST}
}

handle /sentry-tunnel {
	reverse_proxy {$BACKEND_HOST}
}

handle_path /healthz {
	rewrite * /api/healthz
	reverse_proxy {$FRONTEND_HOST}
}

# this regexp matches /[teamSlug]/topic/[topicSlug]/[topicId]
@legacyTopic path_regexp topic ^\/(?P<teamSlug>.*)\/topic\/(?P<topicSlug>.*)\/(?P<topicId>.*)$
redir @legacyTopic /{re.topic.teamSlug}/{re.topic.topicSlug}/{re.topic.topicId}

reverse_proxy {$FRONTEND_HOST}

log {
	level ERROR
}
