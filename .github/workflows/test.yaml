name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:12
        ports: 
          - "5433:5432"
        env:
          POSTGRES_PASSWORD: dev
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      hasura:
        image: hasura/graphql-engine:v1.3.2
        ports:
          - "8080:8080"
        env:
          HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:dev@postgres:5432/postgres
          HASURA_GRAPHQL_DEV_MODE: "true"
          HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
          HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
          HASURA_GRAPHQL_JWT_SECRET: "{ \"jwk_url\": \"https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com\", \"audience\": \"meetnomoreapp\", \"issuer\": \"https://securetoken.google.com/meetnomoreapp\" }"
          HASURA_GRAPHQL_ADMIN_SECRET: dev
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
    - name: Cache node modules
      uses: actions/cache@v2
      env:
        cache-name: cache-node-modules
      with:
        path: ~/.npm
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
    - name: Install dependencies
      run: npm install
    - name: Build project
      run: npm run build
    - name: Run tests
      run: npm run test

